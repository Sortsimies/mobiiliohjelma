<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	
 	<meta http-equiv="Content-Security-Policy" content="
			default-src 'self' 'unsafe-inline' ws://192.168.10.44:3000 http://ajax.aspnetcdn.com https://upload.wikimedia.org/ http://upload.wikimedia.org/ http://code.jquery.com https://code.jquery.com http://cdn.jtsage.com/ https://ssl.gstatic.com http://maps.googleapis.com http://api.openweathermap.org gap: data: blob: filesystem: ; 
	" />
	
	<link rel="stylesheet" href="themes/siniteema.css" />
  <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
	
	<script
	src="https://code.jquery.com/jquery-2.1.4.js"
	integrity="sha256-siFczlgw4jULnUICcdm9gjQPZkw/YPDqhQ9+nAOScE4="
	crossorigin="anonymous"></script>
	
	<script 
   src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <title>Mobiiliohjelmointi</title>
	
	<link  rel="stylesheet" href="http://cdn.jtsage.com/jtsage-datebox/4.0.0/jtsage-datebox-4.0.0.jqm.min.css">
	<script src="http://cdn.jtsage.com/jtsage-datebox/4.0.0/jtsage-datebox-4.0.0.jqm.min.js"></script>
	<script src="http://cdn.jtsage.com/jtsage-datebox/i18n/jtsage-datebox.i18n.fi.utf8.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.15.0/jquery.validate.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.15.0/additional-methods.min.js"></script>
	
	<style>
		[data-role=page]{height: 100% !important; position:relative !important;}
		[data-role=footer]{bottom:0; position:absolute !important; top: auto !important; width:100%;}
		
		
		.boxRound {
			border-radius: 15px 50px;
			background: #73AD21;
			padding: 0px;
			width: 100%;
			height: 170px;
		}
		
		.centerText{
			text-align:center;
		}
		
		.transparentBG{
			 background-color: rgba(8,47,67,0.5);
		}
		
		.urlKatsoNappi{
			float:right;
		}
		.urlPoistaNappi{
			float:left;
		}
		
		.virhe {
			color: red;
		}
		
		label.errorL {
		   /* color:red; */
		   font-weight: bold;
		}
		
		input.errorF {
			border-bottom-color: red;
			border-style: solid;
			border-width: 0.2em;
		}
	</style>
</head>

<body>




	<div data-role="panel" id="menupanel" data-display="overlay" data-position="right" data-theme="a" class="transparentBG">
	<br>
		<ul data-role="listview" data-inset="true">
			<li data-icon="home"><a href="#etusivu">Etusivu</a></li>
			<li data-icon="plus"><a href="#uusi">Uusi</a></li>
			<li data-icon="arrow-r"><a href="#kuvanValinta">Kuvan valinta</a></li>
			<li data-icon="navigation"><a href="#peliSivu">Peli</a></li>
		</ul><br>
		<a href="#" class="ui-btn ui-corner-all ui-btn-inline ui-icon-delete ui-btn-icon-right" data-rel="close" style="float:right">Sulje</a>
	</div>
	


		
		
		
		
		
		
		
		
		
	<div data-role="page" id="etusivu">
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Etusivu</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>
         
		<div role="main" class="ui-content ">
			<div class="boxRound">
				<br/>
				<h2 class="centerText">Miikka Alatalo 2016<br>Mobiiliohjelmointi</h2>
			</div><br>
			<div class="centerText">
				
				<a href="#uusi" class="ui-btn ui-corner-all ui-btn-inline ui-icon-plus ui-btn-icon-right">Uusi kuva</a>
				<a href="#kuvanValinta" class="ui-btn ui-corner-all ui-btn-inline ui-icon-arrow-r ui-btn-icon-right">Valitse kuva</a>
				<a href="#peliSivu" class="ui-btn ui-corner-all ui-btn-inline ui-icon-navigation ui-btn-icon-right">Peli</a>
			</div>
		</div>

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>
		</div>

	</div>
	
	
	
	
	
	
	
	
	
	
	
	
	<div data-role="page" id="kuvanValinta">
	
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Kuvan valinta</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>   

		<div data-role="main" class="ui-content">	
		
			<div class="ui-field-contain">
			    <label for="select-native-1">Kuvan lähde</label>
				<select name="alkuKuvanValinta" id="alkuKuvanValinta">
					<option value="lista" selected="selected">Lista</option>
					<option value="url">URL</option>
				</select>
			</div>
			
			<ul data-role="listview" data-inset="true" id="kuvienListaus"></ul>
			
			
			<div class="ui-field-contain" id="urlLahde">
				<label for="urlLahdeTeksti">URL (vain https://upload.wikimedia.org):</label>
				<input name="urlLahdeTeksti" id="urlLahdeTeksti" value="" type="text">
			</div>
			<button id="urlKatso" class="ui-btn ui-corner-all ui-btn-inline ui-icon-eye ui-btn-icon-right" data-rel="close" style="float:right">Katso kuvaa</button>
		</div>	

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>   
		</div>    
	</div>
	
	
	
	
	
	<div data-role="page" id="uusi" data-title="Uusi matkatapahtuma">
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Uusi kuva</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>  
		<div role="main" class="ui-content">
			<div data-role="popup" id="popupLisays" data-overlay-theme="b">
				<h3 id="lisaysViesti">Lisäys</h3>
			</div>
				
			
                <div class="ui-field-contain">
					<label><img id="kuva" style="display:none" src="" alt="" width="100" height="100"></label>
				
					<button type="button"  disabled class="ui-btn ui-icon-camera ui-btn-icon-left ui-corner-all ui-btn-inline" id="otaKuva">Ota kuva</button>	
					<button type="button"  disabled class="ui-btn ui-corner-all ui-btn-inline" id="lataaKuva">Lataa kuva</button>
	            </div>
				
				<div class="ui-field-contain">
					<label for="automtiedot"> </label>
					<button name="automtiedot" type="button" class="ui-btn ui-corner-all ui-btn-inline" id="automtiedot">Automaattiset tiedot</button>
                </div>
				<form id="rekisterointiForm">
					<div class="ui-field-contain">
						<label for="otsikko">Otsikko</label>
						<input type="text" id="otsikko" name="otsikko" class="tarkastaOtsikko"> 
					</div>
					
					<div class="ui-field-contain"> 
						<label for="kuvaus">Kuvaus</label>
						<textarea id="kuvaus" name="kuvaus"></textarea>
					</div> 
					
					<div class="ui-field-contain">
						<label for="paiva">Päivä</label>
						<input name="paiva" id="paiva" type="text" class="tarkastaPaiva"/>
					</div> 
				
					<div class="ui-field-contain">
						<label for="paikka">Paikka</label>
						<input type="text" id="paikka" name="paikka">
					</div>  
					   
					<div class="ui-field-contain">
						<label for="saa">Sää</label>
						<input type="text" id="saa" name="saa">
					</div>  

					<div class="ui-field-contain"> 
						<button type="button" class="ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-plus" id="lisaa" name="lisaa">Lisää</button>	
						<a href="#" class="ui-btn ui-corner-all ui-btn-a ui-btn-icon-left ui-icon-delete ui-btn-inline" id="tyhjenna" name="tyhjenna">Tyhjennä</a>	
					</div>
				</form>

 
		</div>
		<!-- /content -->
		
		 <div data-role="footer">
			<h4>Mobiiliohjelmointi</h4>
		</div>
		<!-- /footer -->
		
	</div>
	
	

	
	
	
	<div data-role="page" id="kuvanKatselu">

		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Kuva</h1>
			
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>
         
		<div role="main" class="ui-content ">	
		
			<div id="kuvankatseludivi">
				
			</div>
			
   		</div>

		<div data-role="footer">
			<a href="#kuvanValinta" class="ui-btn ui-corner-all ui-btn-inline ui-icon-arrow-l ui-btn-icon-left" style="float:right">Takaisin</a>
			<h1>Mobiiliohjelmointi</h1>
			
		</div>

	</div>
	
	
	
	
	
	

	
	
	<div data-role="page" id="peliSivu">
	
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Peli</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>   

		<div data-role="main" class="ui-content">	
			<div class="ui-field-contain"> 
				<label for="flip-5">Vaikeustaso:</label>
				<select name="flip-5" id="flip-5" data-role="slider" data-theme="c" data-track-theme="a">
					<option value="helppo">Helppo</option>
					<option value="vaikea">Vaikea</option>
				</select>
				
				<div data-role="fieldcontain">
					<label for="slider-step">Tarkkuus toleranssi:</label>
					<input type="range" name="slider-step" id="slider-step" value="1" min="0" max="2" step="0.2" />
				</div>

			</div>
			<div class="ui-field-contain"> 
				<button class="ui-btn ui-corner-all ui-btn-inline ui-icon-plus" id="aloitaPeli">Aloita peli</button>
				<button class="ui-btn ui-corner-all ui-btn-inline ui-icon-delete" id="lopetaPeli">Lopeta peli</button>
			</div>
			<div class="ui-field-contain"> 
				<label id="xLabel" for="xfield">X</label>
				<input type="text" id="xfield" name="xfield" maxlength="4" size="4"/>
			
				<label id="yLabel" for="yfield">Y</label>
				<input type="text" id="yfield" name="yfield"/>
			
				<label id="zLabel" for="zfield">Z</label>
				<input type="text" id="zfield" name="zfield"/>
			</div>
		</div>	

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>   
		</div>    
	</div>
	
	
	
	
	
	
	
	<script type="text/javascript" src="cordova.js"></script> 
	
	<script>
	
		var imgsrc = "";
	
		var deviceReadyDeferred = $.Deferred();
		var jqmReadyDeferredUusi = $.Deferred();
		//var jqmReadyDeferredLahella = $.Deferred();
		
		//$.when(deviceReadyDeferred, jqmReadyDeferredUusi).done( uusiValmis );
		$.when(deviceReadyDeferred, jqmReadyDeferredUusi).done( kameraValmis );
		
		document.addEventListener("deviceReady", onDeviceReady, false);
		
		var deviceReady = false;
		function onDeviceReady() {
			deviceReadyDeferred.resolve(); // jqmReadyDeferredUusi.resolve();
			deviceReady = true;
		}
		
		$(document).on("pagecreate", function() {
				
			$(document).on("pagecontainershow", function(){
				$(".ui-content").height(getRealContentHeight());
			})

			$(window).on("resize orientationchange", function(){
				$(".ui-content").height(getRealContentHeight());
			})
			
			function getRealContentHeight() {
				var activePage = $.mobile.pageContainer.pagecontainer("getActivePage"),
					screen = $.mobile.getScreenHeight(),
					header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight() - 1 : $(".ui-header").outerHeight(),
					// header = $(".ui-header").hasClass("ui-header-fixed", activePage) ? $(".ui-header",  activePage).outerHeight() - 1 : $(".ui-header",  activePage).outerHeight(),
					footer = $(".ui-footer", activePage).hasClass("ui-footer-fixed") ? $(".ui-footer", activePage).outerHeight() - 1 : $(".ui-footer", activePage).outerHeight(),
					contentCurrent = $(".ui-content", activePage).outerHeight() - $(".ui-content", activePage).height();
				
				var content = screen - header - footer - contentCurrent;

				return content;
			}
	
			$(document).on("pagecontainerchange", function() {
				var current = $( ".ui-page-active" ).jqmData( "title" );
					
				$( "[data-role='navbar'] a.ui-btn-active" ).removeClass( "ui-btn-active" );
					
				$( "[data-role='navbar'] a" ).each(function() {
					if ( $( this ).text() === current ) {
						$( this ).addClass( "ui-btn-active" );
					}
				})
			})
		})
	
		$(document).one("pagebeforecreate", function () {	
			$("#popupMenu").enhanceWithin().popup();
			$("#slider-1").slider();
			$( "[data-role=panel]" ).panel().enhanceWithin();
			
		});
		
		
		$(document).on("pagecreate", "#etusivu", function() {

			
		});
		
		$(document).on("pagecreate", "#kuvanKatselu", function() {
			
			
			
		});
		
		$(document).on("pagebeforeshow", "#kuvanKatselu", function() {
			$('#kuvankatseludivi').empty();
			$('#kuvankatseludivi').prepend('<img id="theImg" style="width:100%" src="'+imgsrc+'" />')
			
		});
		
		$(document).on("pagecreate", "#peliSivu", function() {
			
			var watchID = null;
			
			
			
			$("#aloitaPeli").on("tap", function() {
				if(deviceReady){
					
					var targetX;
					var targetY;
					var targetZ;
					var data = {
					  'jsonrpc': '2.0',
					  'method': 'generateIntegers',
					  'params': {
						'apiKey': '00000000-0000-0000-0000-000000000000',
						'n': 3,
						'min': -9,
						'max': 9,
						'replacement': true,
						'base': 10
					  },
					  'id': 1337
					};

					$.ajax({
					  url: 'https://api.random.org/json-rpc/1/invoke',
					  type: "POST",
					  data: JSON.stringify(data),
					  contentType: "application/json; charset=utf-8",
					  dataType: "json"
					}).done(function(data){	
						targetX = data.result.random.data[0];
						targetY = data.result.random.data[1];
						targetZ = data.result.random.data[2];
					})
					.fail(function() {
						targetX = Math.floor((Math.random() * 18) + 0)-9;
						targetY = Math.floor((Math.random() * 18) + 0)-9;
						targetZ = Math.floor((Math.random() * 18) + 0)-9;
					}).always(function() {
						var toleranssi = parseFloat($("#slider-step").val());
						var xDone = false;
						var yDone = false;
						var zDone = false;
						
						$("#xfield").css({'background-color':'white'});
						$("#yfield").css({'background-color':'white'});
						$("#zfield").css({'background-color':'white'});
						$("#xLabel").html("X - target: "+targetX);
						$("#yLabel").html("Y - target: "+targetY);
						$("#zLabel").html("Z - target: "+targetZ);
						
						function onSuccess(acceleration) {
							if($("#flip-5").val() == 'vaikea'){
								xDone=false;
								yDone=false;
								zDone=false;
								$("#xfield").css({'background-color':'white'});
								$("#yfield").css({'background-color':'white'});
								$("#zfield").css({'background-color':'white'});
							}
							var x = acceleration.x.toFixed(5);
							var y = acceleration.y.toFixed(5);
							var z = acceleration.z.toFixed(5);
							$("#xfield").val(x);
							$("#yfield").val(y);
							$("#zfield").val(z);
							
							if( x > targetX-toleranssi && x < targetX+toleranssi){
								xDone=true;
								$("#xfield").css({'background-color':'green'});
							}
							if( y > targetY-toleranssi && y < targetY+toleranssi){
								yDone=true;
								$("#yfield").css({'background-color':'green'});
							}
							if( z > targetZ-toleranssi && z < targetZ+toleranssi){
								zDone=true;
								$("#zfield").css({'background-color':'green'});
							}
							
							if(xDone&&yDone&&zDone){
								lopetaPeli();
							}
						}

						function onError() {
							alert('onError!');
						}

						var options = { frequency: 100 };

						watchID = navigator.accelerometer.watchAcceleration(onSuccess, onError, options);
					});
					
					
				}
			});
			
			$("#lopetaPeli").on("tap", function() {
				lopetaPeli();
			});
			
			function lopetaPeli(){
				if (watchID) {
					navigator.accelerometer.clearWatch(watchID);
					watchID = null;
				}
			}
		});
		
		$(document).on("pagecreate", "#kuvanValinta", function() {
		
			$("#urlKatso").on("tap", function() {
				imgsrc=$("#urlLahdeTeksti").val();
				$.mobile.pageContainer.pagecontainer("change", "#kuvanKatselu");
			});
		
			$( "#kuvienListaus" ).show();
			$( "#urlLahde" ).hide();
			$( "#urlKatso" ).hide();
			$( "#alkuKuvanValinta" ).change(function() {
				var asd = $( "#alkuKuvanValinta" ).val();
				if(asd=="lista"){
					$( "#kuvienListaus" ).show();
					$( "#urlLahde" ).hide();
					$( "#urlKatso" ).hide();
				} else {
					$( "#kuvienListaus" ).hide();
					$( "#urlLahde" ).show();
					$( "#urlKatso" ).show();
				}
			});
			
			$(document).on("pagecontainerbeforeshow", function(event, data){
				if (data.toPage[0].id == "kuvanValinta") {
					listaaKuvat();
				}
			})
			
			
			
		});
		
		$(document).on("pagecreate", "#kuvanKatselu", function() {
			
			
		});
		
		var tiedot = {};
		
		$(document).on("pagecreate", "#uusi", function() {
			jqmReadyDeferredUusi.resolve();
			$("#paiva").datebox({
				mode: "datebox", 
				showInitialValue: true,
				beforeToday: true, 
				useFocus: true,
			})

			$("#lisaa").on("tap", function() {
				if ($("#rekisterointiForm").valid()) {
					tiedot.otsikko=$( "#otsikko" ).val();
					tiedot.kuvaus=$( "#kuvaus" ).val();
					tiedot.paiva=$( "#paiva" ).val();
					tiedot.paikka=$( "#paikka" ).val();
					tiedot.saa=$( "#saa" ).val();
					lisaaKuva();
					$.mobile.pageContainer.pagecontainer("change", "#etusivu");
				}
				

			})
			
			$(document).on("pagecontainerbeforeshow", function(event, data){
				
				if (data.toPage[0].id == "uusi") {
					tyhjenna();
				}
			})
		
			$( "#tyhjenna" ).on("tap", function() {				
				tyhjenna();
			});
			
			$( "#automtiedot" ).on("tap", function() {	
				var dd = new Date();
				var date = dd.toISOString().slice(0,10); 
				var d = date.split("-");
				$("#paiva").val(d[2]+"."+d[1]+"."+d[0]);
				
				navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { timeout: 10000 });

				function onLocationSuccess(position) {
					haePaikkakunta(position.coords.latitude, position.coords.longitude);
					haeSaa(position.coords.latitude, position.coords.longitude);
				}
						
				function onLocationError(err) {
					$("#paikka").val("Haku epäonnistui");
					$("#saa").val("Haku epäonnistui");
				}
			});
			
		});
		
		var validator = $("#rekisterointiForm").validate({	
	
			errorClass: "virhe",				
			rules: {
				otsikko:  {
					required: true,
				},	
				paiva:  {
					required: true,
				},
			},
			messages: {
				otsikko: {
					required: "Pakollinen",
				},
				paiva: {
					required: "Pakollinen",
				},
			},
			highlight: function(element) {
				$(element).addClass('errorF');
				$(element.form).find("label[for=" + element.id + "]").addClass("errorL");
			}, 
			unhighlight: function(element) {
				$(element).removeClass('errorF');
				$(element.form).find("label[for=" + element.id + "]").removeClass("errorL");
			},
			errorPlacement: function(error, element ) {
				error.insertAfter(element.parent());
			},
			submitHandler: function (form) {

			},
		
		})
		
		function tyhjenna(){
			$( "#otsikko" ).val("");
			$( "#paiva" ).val("");
			$( "#paikka" ).val("");
			$( "#saa" ).val("");
			$( "#kuvaus" ).val("");
			validator.resetForm();
		}
		
		function lisaaKuva() {
			var DBOpenRequest = window.indexedDB.open("kuvaIDB", 1);
	
			DBOpenRequest.onupgradeneeded = function (event) {
				var db = DBOpenRequest.result;					
				if (db.objectStoreNames.contains("kuva")) {
					db.deleteObjectStore("kuva");
				}
					
				var objectStore = db.createObjectStore("kuva", { autoIncrement : true });
			}
				
			DBOpenRequest.onsuccess = function(event) {	
				var db = DBOpenRequest.result;	
				var transaction = db.transaction(["kuva"], "readwrite");		
				var objectStore = transaction.objectStore("kuva");
				// Tee tallennus
				objectStore.add(tiedot);
					
				transaction.oncomplete = function(event) {
					db.close();
					tyhjenna();
				}
			
				transaction.onerror = function(event) {
					console.log("Lisääminen ei onnistu");	
				}

			}				
				
			DBOpenRequest.onerror = function(event) {
				console.log("Lisääminen ei onnistu");
			}
		}

		function listaaKuvat() {
			var DBOpenRequest = window.indexedDB.open("kuvaIDB", 1);	
				
			DBOpenRequest.onupgradeneeded = function (event) {
				var db = DBOpenRequest.result;					
				if (db.objectStoreNames.contains("kuva")) {
					db.deleteObjectStore("kuva");
				}
					
				var objectStore = db.createObjectStore("kuva", { autoIncrement : true });
			}
				
			DBOpenRequest.onsuccess = function(event) {
				var db = DBOpenRequest.result;
				var transaction = db.transaction(["kuva"], "readonly");
				var objectStore = transaction.objectStore("kuva");
	
				var html = "";
				var lkm = 0;
						
				objectStore.openCursor().onsuccess  = function(event) {		
					var cursor = event.target.result;
					
					if(cursor){
						html+=	"<li>"+
								'<img src="data:image/jpeg;base64,'+cursor.value.fileURL+'" alt="" width="100" height="100">'+
								cursor.value.otsikko+", "+
								cursor.value.kuvaus+", "+
								cursor.value.paikka+", "+
								cursor.value.paiva+", "+
								cursor.value.saa+
								"<span class='urlPoistaNappi'><button otsikko='"+cursor.value.otsikko+"' paiva='"+cursor.value.paiva+"' class='poistonappi ui-btn ui-corner-all ui-icon-delete ui-btn-icon-notext'>asd</button></span>"+
								"<span class='urlKatsoNappi'><button linkki='"+cursor.value.fileURL+"' class='nappi ui-btn ui-corner-all ui-icon-eye ui-btn-icon-notext'>asd</button></span>"+
								"</li>";
						cursor.continue();
					}
					
				}
						
				transaction.oncomplete = function(event) {
					if(html.length>0){
						$("#kuvienListaus").html(html).listview("refresh");
					}
					$(".nappi").each(function( index ) {
						$( this ).on("tap", function() {				
							var asd = 'data:image/jpeg;base64,'+$( this ).attr('linkki');
							imgsrc = asd;
							$.mobile.pageContainer.pagecontainer("change", "#kuvanKatselu");
						});
					});
					$(".poistonappi").each(function( index ) {
						$( this ).on("tap", function() {	
							poistaDatabasesta($( this ).attr('otsikko'), $( this ).attr('paiva'));
							//console.log($( this ).attr('paiva'));
							//console.log($( this ).attr('otsikko'));
						});
					});
				}
					
				transaction.onerror = function(event) {
					console.log("virhe");				
				}
			}
		}
		
		function poistaDatabasesta(otsikko, paiva){
			var r = confirm("Haluatko varmasti poistaa? ("+otsikko+", "+paiva+")");
			if (r == false) {
				return;
			}
			var DBOpenRequest = window.indexedDB.open("kuvaIDB", 1);	
				
			DBOpenRequest.onupgradeneeded = function (event) {
				var db = DBOpenRequest.result;					
				if (db.objectStoreNames.contains("kuva")) {
					db.deleteObjectStore("kuva");
				}
					
				var objectStore = db.createObjectStore("kuva", { autoIncrement : true });
			}
				
			DBOpenRequest.onsuccess = function(event) {
				var db = DBOpenRequest.result;
				var transaction = db.transaction(["kuva"], "readwrite");
				var objectStore = transaction.objectStore("kuva");
	
				var html = "";
				var lkm = 0;
						
				objectStore.openCursor().onsuccess  = function(event) {		
					var cursor = event.target.result;
					
					if(cursor){
						if(cursor.value.otsikko==otsikko && cursor.value.paiva==paiva){
							var request = cursor.delete();
							request.onsuccess = function() {
								console.log('deleted');
							};
						}
						
						cursor.continue();
					}
					
				}
						
				transaction.oncomplete = function(event) {
					$("#kuvienListaus").html("").listview("refresh");
					listaaKuvat();
				}
					
				transaction.onerror = function(event) {
					console.log("virhe");				
				}
			}
		}

		function haePaikkakunta(lat, lon) {
			$("#paikka").val("");
			
			$.ajax({
				url: "http://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + lon,
				dataType: "json",
				timeout: 5000
			})	
			.done(function(data){	
				var addressComponents = data.results[1].address_components;
				for(i = 0; i < addressComponents.length;i++){
					var types = addressComponents[i].types
						
					if(types == "locality,political"){
						$("#paikka").val(addressComponents[i].long_name); 
					}
				}	
			})
			.fail(function() {
				$("#paikka").val("Haku epäonnistui");
			})
		}
		
		function haeSaa(lat, lon) { 
			$("#saa").val("");
					
			$.ajax({
				url: "http://api.openweathermap.org/data/2.5/weather?lang=fi&lat=" + lat + "&lon=" + lon + "&units=metric&APPID=32f1264bba3945837fa37cc1c29b4db1",
				dataType: "json",
				timeout: 5000
			})	
			.done(function(data){	
				var teksti = data.main.temp.toFixed(0) + "°C , " + data.weather[0].description +", tuuli: "+data.wind.speed+" m/s";
				$("#saa").val(teksti);
			})
			.fail(function() {
				$("#saa").val("Haku epäonnistui");
			})						
		}

		function katsoKuvaa(kuva){
			console.log(kuva);
		}

		var fileURL = "";
		function kameraValmis() {
			$( "#otaKuva" ).prop( "disabled", false );
			$( "#lataaKuva").prop( "disabled", false );
			
			$( "#otaKuva" ).on("tap", function() {				
				navigator.camera.getPicture(onCaptureSuccess, onError, { 
					//destinationType: Camera.DestinationType.FILE_URI  // vain puhelimessa
                    destinationType: Camera.DestinationType.DATA_URL,   // selaimessa ja puhelimessa
					saveToPhotoAlbum: true,
				})
			})
			
			$( "#lataaKuva" ).on("tap", function() {
				navigator.camera.getPicture(onLoadSuccess, onError, { 
					destinationType: Camera.DestinationType.DATA_URL,  
					sourceType: Camera.PictureSourceType.PHOTOLIBRARY
				})
		
			})
			
			function onCaptureSuccess(imageData) {
				//$("#kuva").attr("src", image); //kun FILE_URI
				$("#kuva").attr("src", "data:image/jpeg;base64," + imageData);  // kun DATA_URL
				$( "#kuva").show();
				fileURL = imageData;
				tiedot.fileURL = imageData;
			}
			
			function onLoadSuccess(imageData) {
				//$("#kuva").attr("src", image); // kun FILE_URI
				$("#kuva").attr("src", "data:image/jpeg;base64," + imageData); // kun DATA_URL
				$("#kuva").show();
				fileURL = imageData;
				tiedot.fileURL = imageData;
			}
			
			function onError() {
				console.log("Kuvaaminen/lataaminen ei onnistu");
			}
		}
		
	</script>
</body>

</html>