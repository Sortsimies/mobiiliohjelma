<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	
 	<meta http-equiv="Content-Security-Policy" content="
			default-src 'self' 'unsafe-inline' ws://192.168.10.44:3000 http://code.jquery.com https://code.jquery.com http://cdn.jtsage.com/ https://ssl.gstatic.com http://maps.googleapis.com http://api.openweathermap.org gap: data: blob: filesystem: ; 
	" />
	
	<link rel="stylesheet" href="themes/siniteema.css" />
  <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
	
	<script
	src="https://code.jquery.com/jquery-2.1.4.js"
	integrity="sha256-siFczlgw4jULnUICcdm9gjQPZkw/YPDqhQ9+nAOScE4="
	crossorigin="anonymous"></script>
	
	<script 
   src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <title>Mobiiliohjelmointi</title>
	
	<link  rel="stylesheet" href="http://cdn.jtsage.com/jtsage-datebox/4.0.0/jtsage-datebox-4.0.0.jqm.min.css">
	<script src="http://cdn.jtsage.com/jtsage-datebox/4.0.0/jtsage-datebox-4.0.0.jqm.min.js"></script>
	<script src="http://cdn.jtsage.com/jtsage-datebox/i18n/jtsage-datebox.i18n.fi.utf8.min.js"></script>

	
	<style>
		[data-role=page]{height: 100% !important; position:relative !important;}
		[data-role=footer]{bottom:0; position:absolute !important; top: auto !important; width:100%;}
		
		
		.boxRound {
			border-radius: 15px 50px;
			background: #73AD21;
			padding: 0px;
			width: 100%;
			height: 170px;
		}
		
		.centerText{
			text-align:center;
		}
		
		.transparentBG{
			 background-color: rgba(8,47,67,0.5);
		}
		
		.urlKatsoNappi{
			float:right;
		}
	</style>
</head>

<body>




	<div data-role="panel" id="menupanel" data-display="overlay" data-position="right" data-theme="a" class="transparentBG">
	<br>
		<ul data-role="listview" data-inset="true">
			<li data-icon="home"><a href="#etusivu">Etusivu</a></li>
			<li data-icon="plus"><a href="#uusi">Uusi</a></li>
			<li data-icon="arrow-r"><a href="#kuvanValinta">Kuvan valinta</a></li>
		</ul><br>
		<a href="#" class="ui-btn ui-corner-all ui-btn-inline ui-icon-delete ui-btn-icon-right" data-rel="close" style="float:right">Sulje</a>
	</div>
	


		
		
		
		
		
		
		
		
		
	<div data-role="page" id="etusivu">
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>360&deg; kuvan katselu</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>
         
		<div role="main" class="ui-content ">
			<div class="boxRound">
				<br/>
				<h2 class="centerText">360&deg; kuvan katselu<br>Miikka Alatalo 2016<br>Mobiiliohjelmointi</h2>
			</div><br>
			<div class="centerText">
				<p>Tällä ohjelmalla voit katsoa 360-asteen kuvia puhelimen gyroscopea hyväksikäyttäen.<br>
				Voit valita kuvan valmiista listasta tai voit myös antaa URL-osoitteen kuvalle.
				</p>
				<a href="#kuvanValinta" class="ui-btn ui-corner-all ui-btn-inline ui-icon-arrow-r ui-btn-icon-right">Valitse kuva</a>
			</div>
			<a href="asdasdasd.html" data-ajax="false">asd</a>
			<a href="lisaosa.html" data-ajax="false">dsa</a>
		</div>

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>
		</div>

	</div>
	
	
	
	
	
	
	
	
	
	
	
	
	<div data-role="page" id="kuvanValinta">
	
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Kuvan valinta</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>   

		<div data-role="main" class="ui-content">	
		
			<div class="ui-field-contain">
			    <label for="select-native-1">Kuvan lähde</label>
				<select name="alkuKuvanValinta" id="alkuKuvanValinta">
					<option value="lista" selected="selected">Lista</option>
					<option value="url">URL</option>
				</select>
			</div>
			
			<ul data-role="listview" data-inset="true" id="kuvienListaus"></ul>
			
			
			<div class="ui-field-contain" id="urlLahde">
				<label for="urlLahdeTeksti">Kuvan URL:</label>
				<input name="urlLahdeTeksti" id="urlLahdeTeksti" value="" type="text">
			</div>
			<!-- Lopullisessa toteutuksessa tämä on tod.näk. button -->
			<a href="#kuvanKatselu" id="urlKatso" class="ui-btn ui-corner-all ui-btn-inline ui-icon-eye ui-btn-icon-right" data-rel="close" style="float:right">Katso kuvaa</a>
		</div>	

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>   
		</div>    
	</div>
	
	
	
	
	
	<div data-role="page" id="uusi" data-title="Uusi matkatapahtuma">
		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>Uusi kuva</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>  
		<div role="main" class="ui-content">
			<div data-role="popup" id="popupLisays" data-overlay-theme="b">
				<h3 id="lisaysViesti">Lisäys</h3>
			</div>
				
			<form action="#" method="post" id="lisaaMatkatapahtumaLomake"> 
			
                <div class="ui-field-contain">
					<label><img id="kuva" style="display:none" src="" alt="" width="100" height="100"></label>
				
					<button type="button"  disabled class="ui-btn ui-icon-camera ui-btn-icon-left ui-corner-all ui-btn-inline" id="otaKuva">Ota kuva</button>	
					<button type="button"  disabled class="ui-btn ui-corner-all ui-btn-inline" id="lataaKuva">Lataa kuva</button>
	            </div>
				
				<div class="ui-field-contain">
					<label for="automtiedot"> </label>
					<button name="automtiedot" type="button" class="ui-btn ui-corner-all ui-btn-inline" id="automtiedot">Automaattiset tiedot</button>
                </div>
				
                <div class="ui-field-contain">
                    <label for="otsikko">Otsikko</label>
                    <input type="text" id="otsikko" name="otsikko" class="tarkastaMatkatapahtumaOtsikko"> 
                </div>
				
				<div class="ui-field-contain"> 
                    <label for="kuvaus">Kuvaus1</label>
                    <textarea id="kuvaus" name="kuvaus"></textarea>
                </div> 
				
                <div class="ui-field-contain">
                    <label for="paiva">Päivä</label>
                    <input name="paiva" id="paiva" type="text" />
				</div> 
			
                <div class="ui-field-contain">
                    <label for="paikka">Paikka</label>
                    <input type="text" id="paikka" name="paikka">
                </div>  
                   
                <div class="ui-field-contain">
                    <label for="saa">Sää</label>
                    <input type="text" id="saa" name="saa">
                </div>  

				<div class="ui-field-contain"> 
					<button type="button" class="ui-btn ui-corner-all ui-btn-inline" id="lisaa" name="lisaa">Lisää</button>	
					<a href="#" class="ui-btn ui-corner-all ui-btn-a ui-btn-icon-left ui-icon-delete ui-btn-inline" id="tyhjenna" name="tyhjenna">Tyhjennä</a>	
				</div>
			</form> 
 
		</div>
		<!-- /content -->
		
		 <div data-role="footer">
			<h4>Mobiiliohjelmointi</h4>
		</div>
		<!-- /footer -->
		
	</div>
	
	

	
	
	
	<div data-role="page" id="kuvanKatselu">

		<div data-role="header">
			<a href="#etusivu" class="ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext">Etusivu</a>
			<h1>360 kuvan katselu - Kuva</h1>
			<a href="#menupanel" class="ui-btn ui-btn-inline  ui-corner-all ui-icon-bars ui-btn-icon-notext">Menu</a>
		</div>
         
		<div role="main" class="ui-content ">	
		
			<div>
				<p>Tähän tulee itse kuvan katselu, sitten kun toteutetaan ohjelma lopullisesti</p>
			</div>
			
   		</div>

		<div data-role="footer">
			<h1>Mobiiliohjelmointi</h1>
		</div>

	</div>
	
	
	
	
	
	

	
	
	
	
	
	
	
	
	
	
	<script type="text/javascript" src="cordova.js"></script> 
	
	<script>
	
		var deviceReadyDeferred = $.Deferred();
		var jqmReadyDeferredUusi = $.Deferred();
		//var jqmReadyDeferredLahella = $.Deferred();
		
		//$.when(deviceReadyDeferred, jqmReadyDeferredUusi).done( uusiValmis );
		$.when(deviceReadyDeferred, jqmReadyDeferredUusi).done( kameraValmis );
		
		document.addEventListener("deviceReady", onDeviceReady, false);
		
		var deviceReady = false;
		function onDeviceReady() {
			deviceReadyDeferred.resolve(); // jqmReadyDeferredUusi.resolve();
			deviceReady = true;
		}
		
		$(document).on("pagecreate", function() {
				
			$(document).on("pagecontainershow", function(){
				$(".ui-content").height(getRealContentHeight());
			})

			$(window).on("resize orientationchange", function(){
				$(".ui-content").height(getRealContentHeight());
			})
			
			function getRealContentHeight() {
				var activePage = $.mobile.pageContainer.pagecontainer("getActivePage"),
					screen = $.mobile.getScreenHeight(),
					header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight() - 1 : $(".ui-header").outerHeight(),
					// header = $(".ui-header").hasClass("ui-header-fixed", activePage) ? $(".ui-header",  activePage).outerHeight() - 1 : $(".ui-header",  activePage).outerHeight(),
					footer = $(".ui-footer", activePage).hasClass("ui-footer-fixed") ? $(".ui-footer", activePage).outerHeight() - 1 : $(".ui-footer", activePage).outerHeight(),
					contentCurrent = $(".ui-content", activePage).outerHeight() - $(".ui-content", activePage).height();
				
				var content = screen - header - footer - contentCurrent;

				return content;
			}
	
			$(document).on("pagecontainerchange", function() {
				var current = $( ".ui-page-active" ).jqmData( "title" );
					
				$( "[data-role='navbar'] a.ui-btn-active" ).removeClass( "ui-btn-active" );
					
				$( "[data-role='navbar'] a" ).each(function() {
					if ( $( this ).text() === current ) {
						$( this ).addClass( "ui-btn-active" );
					}
				})
			})
		})
	
		$(document).one("pagebeforecreate", function () {	
			$("#popupMenu").enhanceWithin().popup();
			 $( "[data-role=panel]" ).panel().enhanceWithin();
		});
		
		$(document).on("pagecreate", "#etusivu", function() {

			
		});
		
		$(document).on("pagebeforeshow", "#kuvanValinta", function() {
			
		});
		
		$(document).on("pagecreate", "#kuvanValinta", function() {
			$( "#kuvienListaus" ).show();
			$( "#urlLahde" ).hide();
			$( "#urlKatso" ).hide();
			$( "#alkuKuvanValinta" ).change(function() {
				var asd = $( "#alkuKuvanValinta" ).val();
				if(asd=="lista"){
					$( "#kuvienListaus" ).show();
					$( "#urlLahde" ).hide();
					$( "#urlKatso" ).hide();
				} else {
					$( "#kuvienListaus" ).hide();
					$( "#urlLahde" ).show();
					$( "#urlKatso" ).show();
				}
			});
			
			$(document).on("pagecontainerbeforeshow", function(event, data){
				if (data.toPage[0].id == "kuvanValinta") {
					listaaKuvat();
				}
			})
			
			
			
		});
		
		$(document).on("pagecreate", "#kuvanKatselu", function() {
			
			
		});
		
		var tiedot = {};
		
		$(document).on("pagecreate", "#uusi", function() {
			jqmReadyDeferredUusi.resolve();
			$("#paiva").datebox({
				mode: "datebox", 
				showInitialValue: true,
				beforeToday: true, 
				useFocus: true,
			})

			$("#lisaa").on("tap", function() {
				tiedot.otsikko=$( "#otsikko" ).val();
				tiedot.kuvaus=$( "#kuvaus" ).val();
				tiedot.paiva=$( "#paiva" ).val();
				tiedot.paikka=$( "#paikka" ).val();
				tiedot.saa=$( "#saa" ).val();
				lisaaKuva();

			})
			
			$(document).on("pagecontainerbeforeshow", function(event, data){
				
				if (data.toPage[0].id == "uusi") {
					tyhjenna();
				}
			})
		
			$( "#tyhjenna" ).on("tap", function() {				
				tyhjenna();
			});
			
			$( "#automtiedot" ).on("tap", function() {	
				var dd = new Date();
				var date = dd.toISOString().slice(0,10); 
				var d = date.split("-");
				$("#paiva").val(d[2]+"."+d[1]+"."+d[0]);
				
				navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { timeout: 10000 });

				function onLocationSuccess(position) {
					haePaikkakunta(position.coords.latitude, position.coords.longitude);
					haeSaa(position.coords.latitude, position.coords.longitude);
				}
						
				function onLocationError(err) {
					$("#paikka").val("Haku epäonnistui");
					$("#saa").val("Haku epäonnistui");
				}
			});
			
		});
		
		function tyhjenna(){
			$( "#otsikko" ).val("");
			$( "#paiva" ).val("");
			$( "#paikka" ).val("");
			$( "#saa" ).val("");
			$( "#kuvaus" ).val("");
		}
		
		function lisaaKuva() {
			var DBOpenRequest = window.indexedDB.open("kuvaIDB", 1);
	
			DBOpenRequest.onupgradeneeded = function (event) {
				var db = DBOpenRequest.result;					
				if (db.objectStoreNames.contains("kuva")) {
					db.deleteObjectStore("kuva");
				}
					
				var objectStore = db.createObjectStore("kuva", { autoIncrement : true });
			}
				
			DBOpenRequest.onsuccess = function(event) {	
				var db = DBOpenRequest.result;	
				var transaction = db.transaction(["kuva"], "readwrite");		
				var objectStore = transaction.objectStore("kuva");
				// Tee tallennus
				objectStore.add(tiedot);
					
				transaction.oncomplete = function(event) {
					db.close();
					tyhjenna();
				}
			
				transaction.onerror = function(event) {
					console.log("Lisääminen ei onnistu");	
				}

			}				
				
			DBOpenRequest.onerror = function(event) {
				console.log("Lisääminen ei onnistu");
			}
		}

		function listaaKuvat() {
			var DBOpenRequest = window.indexedDB.open("kuvaIDB", 1);	
				
			DBOpenRequest.onupgradeneeded = function (event) {
				var db = DBOpenRequest.result;					
				if (db.objectStoreNames.contains("kuva")) {
					db.deleteObjectStore("kuva");
				}
					
				var objectStore = db.createObjectStore("kuva", { autoIncrement : true });
			}
				
			DBOpenRequest.onsuccess = function(event) {
				var db = DBOpenRequest.result;
				var transaction = db.transaction(["kuva"], "readonly");
				var objectStore = transaction.objectStore("kuva");
	
				var html = "";
				var lkm = 0;
						
				objectStore.openCursor().onsuccess  = function(event) {		
					var cursor = event.target.result;
					
					if(cursor){
						html+=	"<li>"+cursor.value.otsikko+", "+
								cursor.value.kuvaus+", "+
								cursor.value.paikka+", "+
								cursor.value.paiva+", "+
								cursor.value.saa+
								"<span class='urlKatsoNappi'><button linkki='"+cursor.value.otsikko+"' class='nappi ui-btn ui-corner-all ui-icon-eye ui-btn-icon-notext'>asd</button></span>"+
								"</li>";
						cursor.continue();
					}
					
				}
						
				transaction.oncomplete = function(event) {
					if(html.length>0){
						$("#kuvienListaus").html(html).listview("refresh");
					}
					$(".nappi").each(function( index ) {
						console.log( index + ": " + $( this ).attr('linkki') );
						$( this ).on("tap", function() {				
							console.log($( this ).attr('linkki'));
						});
					});
				}
					
				transaction.onerror = function(event) {
					console.log("virhe");				
				}
			}
		}
		
		function asd(teksti){
			console.log(teksti);
		}

		function haePaikkakunta(lat, lon) {
			$("#paikka").val("");
			
			$.ajax({
				url: "http://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + lon,
				dataType: "json",
				timeout: 5000
			})	
			.done(function(data){	
				var addressComponents = data.results[1].address_components;
				for(i = 0; i < addressComponents.length;i++){
					var types = addressComponents[i].types
						
					if(types == "locality,political"){
						$("#paikka").val(addressComponents[i].long_name); 
					}
				}	
			})
			.fail(function() {
				$("#paikka").val("Haku epäonnistui");
			})
		}
		
		function haeSaa(lat, lon) { 
			$("#saa").val("");
					
			$.ajax({
				url: "http://api.openweathermap.org/data/2.5/weather?lang=fi&lat=" + lat + "&lon=" + lon + "&units=metric&APPID=32f1264bba3945837fa37cc1c29b4db1",
				dataType: "json",
				timeout: 5000
			})	
			.done(function(data){	
				var teksti = data.main.temp.toFixed(0) + "°C , " + data.weather[0].description +", tuuli: "+data.wind.speed+" m/s";
				$("#saa").val(teksti);
			})
			.fail(function() {
				$("#saa").val("Haku epäonnistui");
			})						
		}

		function katsoKuvaa(kuva){
			console.log(kuva);
		}

		
		function kameraValmis() {
			$( "#otaKuva" ).prop( "disabled", false );
			$( "#lataaKuva").prop( "disabled", false );
			
			$( "#otaKuva" ).on("tap", function() {				
				navigator.camera.getPicture(onCaptureSuccess, onError, { 
					//destinationType: Camera.DestinationType.FILE_URI  // vain puhelimessa
                    destinationType: Camera.DestinationType.DATA_URL,   // selaimessa ja puhelimessa
					saveToPhotoAlbum: true,
				})
			})
			
			$( "#lataaKuva" ).on("tap", function() {
				navigator.camera.getPicture(onLoadSuccess, onError, { 
					destinationType: Camera.DestinationType.DATA_URL,  
					sourceType: Camera.PictureSourceType.PHOTOLIBRARY
				})
		
			})
			
			function onCaptureSuccess(imageData) {
				//$("#kuva").attr("src", image); //kun FILE_URI
				$("#kuva").attr("src", "data:image/jpeg;base64," + imageData);  // kun DATA_URL
				$( "#kuva").show();
				fileURL = imageData;
			}
			
			function onLoadSuccess(imageData) {
				//$("#kuva").attr("src", image); // kun FILE_URI
				$("#kuva").attr("src", "data:image/jpeg;base64," + imageData); // kun DATA_URL
				$("#kuva").show();
				fileURL = imageData;
			}
			
			function onError() {
				console.log("Kuvaaminen/lataaminen ei onnistu");
			}
		}
		
	</script>
</body>

</html>